<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login | 3 Ball Network</title>
    <meta name="description" content="Sign in to your 3 Ball Network account" />
    <meta name="theme-color" content="#00b4d8" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Urbanist:wght@400;700;900&family=Bebas+Neue&display=swap"
      rel="stylesheet"
    />

    <!-- PWA -->
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" type="image/png" href="/logo.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="3 Ball Network" />
    <link rel="apple-touch-icon" href="/logo.png" />

    <!-- Security Headers -->
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://www.googleapis.com https://apis.google.com https://securetoken.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://*.googleapis.com wss://*.firebaseio.com; frame-src 'self' https://www.google.com https://*.firebaseapp.com"
    />
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <meta http-equiv="X-Frame-Options" content="DENY" />
    <meta http-equiv="X-XSS-Protection" content="1; mode=block" />
    <meta
      http-equiv="Referrer-Policy"
      content="strict-origin-when-cross-origin"
    />
    <meta
      http-equiv="Permissions-Policy"
      content="geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), speaker=()"
    />
    <meta
      http-equiv="Strict-Transport-Security"
      content="max-age=31536000; includeSubDomains"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Urbanist', sans-serif;
        background: linear-gradient(135deg, #0077b6, #90e0ef);
        min-height: 100vh;
        color: #333;
        display: flex;
        flex-direction: column;
      }

      .banner-logo {
        width: 100%;
        background: #111;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 1.5em 0 1em 0;
      }

      .banner-logo-img {
        max-width: 320px;
        width: 90vw;
        height: auto;
        display: block;
        filter: drop-shadow(0 8px 32px rgba(0, 0, 0, 0.18));
        border-radius: 24px;
        padding: 0.5em 1.5em;
      }

      header {
        text-align: center;
        padding: 2em 0 1em 0;
      }

      .site-title {
        font-family: 'Montserrat', sans-serif;
        font-size: 2.5em;
        font-weight: 900;
        color: #fff;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        margin-bottom: 0.2em;
      }

      .site-tagline {
        font-size: 1.2em;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 400;
      }

      nav {
        background: rgba(255, 255, 255, 0.95);
        padding: 1em 0;
        text-align: center;
        border-radius: 0 0 22px 22px;
        margin: 0 auto 2em auto;
        max-width: 1200px;
        backdrop-filter: blur(10px);
      }

      nav a {
        color: #007cba;
        text-decoration: none;
        font-weight: 700;
        font-size: 1.1em;
        margin: 0 1.5em;
        padding: 0.5em 1em;
        border-radius: 8px;
        transition: all 0.3s ease;
        display: inline-block;
        letter-spacing: 0.8px;
        text-transform: uppercase;
      }

      nav a:hover,
      nav a.active {
        background: linear-gradient(135deg, #007cba, #00b4d8);
        color: #fff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      main {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 2em;
      }

      .hero {
        background: rgba(255, 255, 255, 0.95);
        padding: 3em 2.5em;
        border-radius: 20px;
        text-align: center;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        max-width: 450px;
        width: 100%;
      }

      .hero h2 {
        font-family: 'Montserrat', sans-serif;
        font-size: 2.5em;
        font-weight: 900;
        color: #007cba;
        margin-bottom: 0.5em;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
      }

      .hero p {
        font-size: 1.1em;
        color: #666;
        margin-bottom: 2em;
        line-height: 1.5;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 1.5em;
      }

      label {
        font-weight: 700;
        color: #333;
        text-align: left;
        margin-bottom: 0.5em;
        font-size: 1em;
      }

      input {
        padding: 1em;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1em;
        font-family: 'Urbanist', sans-serif;
        transition: all 0.3s ease;
        background: #fff;
      }

      input:focus {
        outline: none;
        border-color: #00b4d8;
        box-shadow: 0 0 0 3px rgba(0, 180, 216, 0.1);
      }

      .password-container {
        position: relative;
        display: flex;
        align-items: center;
      }

      .password-container input {
        flex: 1;
        padding-right: 3.5em;
      }

      .password-container button {
        position: absolute;
        right: 1em;
        background: none;
        border: none;
        color: #007cba;
        font-weight: 700;
        cursor: pointer;
        padding: 0.5em;
        font-size: 0.9em;
        transition: color 0.3s ease;
      }

      .password-container button:hover {
        color: #00b4d8;
      }

      button[type='submit'] {
        background: linear-gradient(135deg, #007cba, #00b4d8);
        color: #fff;
        padding: 1.2em;
        border: none;
        border-radius: 8px;
        font-size: 1.1em;
        font-weight: 700;
        font-family: 'Urbanist', sans-serif;
        text-transform: uppercase;
        letter-spacing: 1px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 1em;
      }

      button[type='submit']:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 123, 186, 0.3);
      }

      button[type='submit']:active {
        transform: translateY(0);
      }

      button[type='submit']:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
      }

      .login-link {
        margin-top: 2em;
        font-size: 1em;
        color: #666;
      }

      .login-link a {
        color: #007cba;
        text-decoration: none;
        font-weight: 700;
        transition: color 0.3s ease;
      }

      .login-link a:hover {
        color: #00b4d8;
        text-decoration: underline;
      }

      #loginError {
        color: #d90429;
        font-weight: 700;
        text-align: center;
        margin-top: 1em;
        display: none;
        background: rgba(217, 4, 41, 0.1);
        padding: 1em;
        border-radius: 8px;
        border: 1px solid rgba(217, 4, 41, 0.3);
        font-size: 14px;
        line-height: 1.4;
        animation: slideIn 0.3s ease;
      }

      #loginError.show {
        display: block !important;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Debug indicator */
      .debug-indicator {
        position: fixed;
        top: 10px;
        right: 10px;
        background: #007bff;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 1000;
        display: none;
      }

      .test-credentials {
        background: rgba(0, 180, 216, 0.1);
        padding: 1em;
        border-radius: 8px;
        border: 1px solid rgba(0, 180, 216, 0.3);
        margin-top: 1em;
        font-size: 0.9em;
        color: #007cba;
      }

      .test-credentials h4 {
        margin-bottom: 0.5em;
      }

      @media (max-width: 768px) {
        .site-title {
          font-size: 2em;
        }

        nav a {
          margin: 0 0.5em;
          font-size: 1em;
        }

        .hero {
          padding: 2em 1.5em;
          margin: 1em;
        }

        .hero h2 {
          font-size: 2em;
        }
      }
    </style>
  </head>
  <body>
    <div class="banner-logo">
      <img src="/logo.png" alt="3 Ball Network Logo" class="banner-logo-img" />
    </div>

    <header>
      <div class="site-title">3 Ball Network</div>
      <div class="site-tagline">Welcome Back</div>
    </header>

    <nav>
      <a href="/">Home</a>
      <a href="/about.html">About Us</a>
      <a href="/overview.html">Overview</a>
      <a href="/register.html">Register</a>
      <a href="/login.html" class="active">Log In</a>
    </nav>

    <main>
      <div class="hero">
        <h2>Sign In</h2>
        <p>Access your dashboard and continue your basketball journey</p>

        <form id="loginForm">
          <div>
            <label for="email">Email Address</label>
            <input
              type="email"
              id="email"
              placeholder="Enter your email"
              required
            />
          </div>

          <div>
            <label for="password">Password</label>
            <div class="password-container">
              <input
                type="password"
                id="password"
                placeholder="Enter your password"
                required
              />
              <button type="button" onclick="togglePassword()">Show</button>
            </div>
          </div>

          <button type="submit" id="loginBtn">Sign In</button>
        </form>

        <div class="login-link">
          Don't have an account? <a href="/register.html">Register here</a>
        </div>

        <div id="loginError"></div>
      </div>
    </main>

    <!-- Debug indicator -->
    <div id="debugIndicator" class="debug-indicator"></div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="/assets/js/firebaseConfig-compat.js"></script>

    <script>
      // Enhanced Error Handling Functions
      function showError(message, duration = 10000) {
        console.log('üö® Showing error:', message);

        const errorDiv = document.getElementById('loginError');
        const debugIndicator = document.getElementById('debugIndicator');

        if (errorDiv) {
          errorDiv.textContent = message;
          errorDiv.style.display = 'block';
          errorDiv.classList.add('show');

          // Also show in debug indicator
          if (debugIndicator) {
            debugIndicator.textContent = 'Error: ' + message.substring(0, 30) + '...';
            debugIndicator.style.display = 'block';
            debugIndicator.style.background = '#dc3545';
          }

          // Auto-hide after duration
          setTimeout(() => {
            errorDiv.style.display = 'none';
            errorDiv.classList.remove('show');
            if (debugIndicator) {
              debugIndicator.style.display = 'none';
            }
          }, duration);
        } else {
          console.error('‚ùå Error div not found!');
          alert('Error: ' + message); // Fallback
        }
      }

      function showSuccess(message, duration = 5000) {
        console.log('‚úÖ Showing success:', message);

        const errorDiv = document.getElementById('loginError');
        const debugIndicator = document.getElementById('debugIndicator');

        if (errorDiv) {
          errorDiv.textContent = message;
          errorDiv.style.display = 'block';
          errorDiv.style.background = 'rgba(40, 167, 69, 0.1)';
          errorDiv.style.color = '#28a745';
          errorDiv.style.borderColor = 'rgba(40, 167, 69, 0.3)';
          errorDiv.classList.add('show');

          if (debugIndicator) {
            debugIndicator.textContent = 'Success: ' + message.substring(0, 30) + '...';
            debugIndicator.style.display = 'block';
            debugIndicator.style.background = '#28a745';
          }

          // Auto-hide after duration
          setTimeout(() => {
            errorDiv.style.display = 'none';
            errorDiv.classList.remove('show');
            // Reset styles
            errorDiv.style.background = 'rgba(217, 4, 41, 0.1)';
            errorDiv.style.color = '#d90429';
            errorDiv.style.borderColor = 'rgba(217, 4, 41, 0.3)';
            if (debugIndicator) {
              debugIndicator.style.display = 'none';
            }
          }, duration);
        }
      }

      function hideError() {
        const errorDiv = document.getElementById('loginError');
        const debugIndicator = document.getElementById('debugIndicator');

        if (errorDiv) {
          errorDiv.style.display = 'none';
          errorDiv.classList.remove('show');
        }
        if (debugIndicator) {
          debugIndicator.style.display = 'none';
        }
      }

      // Debug: Prevent unwanted navigation
      console.log('üîç Login page loaded at:', new Date().toISOString());

      // Simple debug logging without interfering with navigation
      console.log('ÔøΩ Original URL:', window.location.href);

      // Initialize Firebase
      console.log('üî• Initializing Firebase...');

      // Check if Firebase config script is available
      if (typeof getFirebaseConfig === 'undefined') {
        console.error('‚ùå Firebase config function not available');
        console.log('üîß Attempting to load Firebase config...');

        // Try to load the config manually
        const configScript = document.createElement('script');
        configScript.src = '/assets/js/firebaseConfig-compat.js';
        configScript.onload = function () {
          console.log('‚úÖ Firebase config script loaded');
          initializeFirebaseAuth();
        };
        configScript.onerror = function () {
          console.error('‚ùå Failed to load Firebase config script');
          document.getElementById('loginError').textContent =
            'Configuration error. Please refresh the page.';
          document.getElementById('loginError').style.display = 'block';
        };
        document.head.appendChild(configScript);
        return;
      }

      initializeFirebaseAuth();

      function initializeFirebaseAuth() {
        const config = getFirebaseConfig();
        if (config) {
          try {
            firebase.initializeApp(config);
            console.log('‚úÖ Firebase initialized successfully');
            console.log('üîê Auth available:', !!firebase.auth);
            console.log('üóÉÔ∏è Firestore available:', !!firebase.firestore);
          } catch (error) {
            console.error('‚ùå Firebase initialization error:', error);
            document.getElementById('loginError').textContent =
              'Authentication system initialization failed. Please refresh the page.';
            document.getElementById('loginError').style.display = 'block';
          }
        } else {
          console.error('‚ùå Failed to get Firebase config');
          document.getElementById('loginError').textContent =
            'System configuration error. Please try again later.';
          document.getElementById('loginError').style.display = 'block';
        }
      }

      // Toggle password visibility
      function togglePassword() {
        const field = document.getElementById('password');
        const button = field.parentNode.querySelector('button');

        if (field.type === 'password') {
          field.type = 'text';
          button.textContent = 'Hide';
        } else {
          field.type = 'password';
          button.textContent = 'Show';
        }
      }

      // Enhanced form submission handler with comprehensive error feedback
      document
        .getElementById('loginForm')
        .addEventListener('submit', function (e) {
          e.preventDefault();
          console.log('üîÑ Form submitted');

          const email = document.getElementById('email').value.trim();
          const password = document.getElementById('password').value;
          const button = document.getElementById('loginBtn');

          console.log('üìß Email:', email);
          console.log('üîê Password length:', password.length);

          // Input validation with enhanced feedback
          if (!email || !password) {
            console.log('‚ùå Missing fields');
            showError('Please fill in all fields');
            return;
          }

          // Email format validation
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(email)) {
            console.log('‚ùå Invalid email format');
            showError('Please enter a valid email address');
            return;
          }

          // Hide previous errors and show loading
          hideError();
          button.textContent = 'Signing In...';
          button.disabled = true;

          // Check Firebase availability
          if (!window.firebase || !firebase.auth) {
            console.error('‚ùå Firebase not available');
            showError('Authentication system not loaded. Please refresh the page.');
            button.textContent = 'Sign In';
            button.disabled = false;
            return;
          }

          console.log('üî• Firebase available, attempting login...');

          // Attempt login with enhanced error handling
          firebase.auth()
            .signInWithEmailAndPassword(email, password)
            .then(async (userCredential) => {
              const user = userCredential.user;
              console.log('‚úÖ Login successful:', user.uid);
              showSuccess('Login successful! Checking your role...');

              try {
                // Get user role from Firestore with timeout
                const userDocPromise = firebase.firestore()
                  .collection('users')
                  .doc(user.uid)
                  .get();

                const timeoutPromise = new Promise((_, reject) => {
                  setTimeout(() => reject(new Error('Timeout: Database query took too long')), 10000);
                });

                const userDoc = await Promise.race([userDocPromise, timeoutPromise]);

                if (userDoc.exists) {
                  const userData = userDoc.data();
                  const role = userData.role;

                  console.log('üë§ User role:', role);
                  showSuccess(`Welcome ${userData.name || email}! Redirecting to ${role} portal...`);

                  // Determine redirect URL
                  let redirectUrl;
                  switch (role) {
                    case 'player':
                      redirectUrl = '/player.html';
                      break;
                    case 'coach':
                      redirectUrl = '/coach.html';
                      break;
                    case 'scout':
                      redirectUrl = '/scout.html';
                      break;
                    case 'fan':
                      redirectUrl = '/fan.html';
                      break;
                    case 'admin':
                      redirectUrl = '/admin.html';
                      break;
                    default:
                      redirectUrl = '/register.html?setup=true';
                  }

                  console.log('üîÑ Redirecting to:', redirectUrl);

                  // Redirect after 2 seconds
                  setTimeout(() => {
                    try {
                      window.location.href = redirectUrl;
                    } catch (error) {
                      console.error('‚ùå Redirect failed:', error);
                      showError('Redirect failed. Please click here: ' + redirectUrl);
                    }
                  }, 2000);
                } else {
                  console.error('‚ùå User profile not found');
                  showError('User profile not found. Please contact support or register again.');
                  button.textContent = 'Sign In';
                  button.disabled = false;
                }
              } catch (error) {
                console.error('‚ùå Error getting user role:', error);
                showError('Error accessing your profile: ' + error.message);
                button.textContent = 'Sign In';
                button.disabled = false;
              }
            })
            .catch(error => {
              console.error('‚ùå Login error:', error);
              button.textContent = 'Sign In';
              button.disabled = false;

              // Handle specific Firebase Auth errors with detailed messages
              let errorMessage = 'Login failed. Please try again.';

              switch (error.code) {
                case 'auth/user-not-found':
                  errorMessage = 'No account found with this email address. Please check your email or register first.';
                  break;
                case 'auth/wrong-password':
                  errorMessage = 'Incorrect password. Please check your password and try again.';
                  break;
                case 'auth/invalid-email':
                  errorMessage = 'Please enter a valid email address.';
                  break;
                case 'auth/user-disabled':
                  errorMessage = 'This account has been disabled. Please contact support.';
                  break;
                case 'auth/too-many-requests':
                  errorMessage = 'Too many failed attempts. Please wait a few minutes and try again.';
                  break;
                case 'auth/network-request-failed':
                  errorMessage = 'Network error. Please check your internet connection and try again.';
                  break;
                case 'auth/invalid-credential':
                  errorMessage = 'Invalid login credentials. Please check your email and password.';
                  break;
                default:
                  errorMessage = error.message || 'Login failed. Please try again.';
              }

              console.log('üö® Showing error to user:', errorMessage);
              showError(errorMessage);
            });
            errorDiv.style.display = 'block';
            return;
          }

          // Email validation
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(email)) {
            errorDiv.textContent = 'Please enter a valid email address';
            errorDiv.style.display = 'block';
            return;
          }

          // Hide error and show loading
          errorDiv.style.display = 'none';
          button.textContent = 'Signing In...';
          button.disabled = true;

          // Check if Firebase is available
          if (typeof firebase === 'undefined' || !firebase.auth) {
            console.error('‚ùå Firebase not available');
            button.textContent = 'Sign In';
            button.disabled = false;
            errorDiv.textContent =
              'Authentication system not available. Please try again.';
            errorDiv.style.display = 'block';
            return;
          }

          // Firebase Authentication
          firebase
            .auth()
            .signInWithEmailAndPassword(email, password)
            .then(async userCredential => {
              const user = userCredential.user;
              console.log('‚úÖ User signed in:', user.uid);

              // Get user role from Firestore
              try {
                const userDoc = await firebase
                  .firestore()
                  .collection('users')
                  .doc(user.uid)
                  .get();
                if (userDoc.exists) {
                  const userData = userDoc.data();
                  const role = userData.role;

                  console.log('üë§ User data:', userData);
                  console.log('üë§ User role:', role);
                  console.log('üîÑ Redirecting to', role, 'portal...');

                  // Debug: Log all user data for troubleshooting
                  console.table({
                    'User ID': user.uid,
                    Email: user.email,
                    Role: role,
                    Name: userData.name || 'Not set',
                    Position: userData.position || 'Not set',
                    School: userData.school || 'Not set',
                  });

                  // Redirect based on role
                  console.log('üöÄ About to redirect to:', role, 'portal');

                  let redirectUrl;
                  switch (role) {
                    case 'player':
                      redirectUrl = '/player.html';
                      break;
                    case 'coach':
                      redirectUrl = '/coach.html';
                      break;
                    case 'scout':
                      redirectUrl = '/scout.html';
                      break;
                    case 'fan':
                      redirectUrl = '/fan.html';
                      break;
                    case 'admin':
                      redirectUrl = '/admin.html';
                      break;
                    default:
                      console.warn('‚ö†Ô∏è Unknown role:', role);
                      redirectUrl = '/register.html?setup=true';
                  }
                  console.log('üéØ Redirecting to:', redirectUrl);

                  // Add a small delay to ensure all console logs are visible
                  setTimeout(() => {
                    console.log('üîÑ Executing redirect now...');
                    try {
                      window.location.href = redirectUrl;
                    } catch (error) {
                      console.error('‚ùå Direct href redirect failed:', error);
                      try {
                        window.location.replace(redirectUrl);
                      } catch (error2) {
                        console.error('‚ùå Replace redirect failed:', error2);
                        window.location.assign(redirectUrl);
                      }
                    }
                  }, 500);
                } else {
                  throw new Error(
                    'User profile not found. Please contact support.'
                  );
                }
              } catch (error) {
                console.error('‚ùå Error getting user role:', error);
                button.textContent = 'Sign In';
                button.disabled = false;
                errorDiv.textContent =
                  'Error accessing user profile: ' + error.message;
                errorDiv.style.display = 'block';
              }
            })
            .catch(error => {
              console.error('‚ùå Login error:', error);
              button.textContent = 'Sign In';
              button.disabled = false;

              // Handle specific Firebase Auth errors
              let errorMessage = 'Login failed. Please try again.';

              switch (error.code) {
                case 'auth/user-not-found':
                  errorMessage =
                    'No account found with this email address. Please register first.';
                  break;
                case 'auth/wrong-password':
                  errorMessage = 'Incorrect password. Please try again.';
                  break;
                case 'auth/invalid-email':
                  errorMessage = 'Please enter a valid email address.';
                  break;
                case 'auth/user-disabled':
                  errorMessage =
                    'This account has been disabled. Please contact support.';
                  break;
                case 'auth/too-many-requests':
                  errorMessage =
                    'Too many failed attempts. Please try again later.';
                  break;
                case 'auth/network-request-failed':
                  errorMessage =
                    'Network error. Please check your connection and try again.';
                  break;
                default:
                  errorMessage =
                    error.message || 'Login failed. Please try again.';
              }

              errorDiv.textContent = errorMessage;
              errorDiv.style.display = 'block';
            });
        });

      // Load test user creation script
      const script = document.createElement('script');
      script.src = '/assets/js/create-test-user.js';
      document.head.appendChild(script);
    </script>
  </body>
</html>
