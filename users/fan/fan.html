<!DOCTYPE html>
<html lang="en" id="html-root">
<head>
  <meta charset="UTF-8">
  <title>Fan Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Critical CSS should be inlined here for above-the-fold content -->
  <link rel="stylesheet" href="/style.css">
  <!-- Preload fonts for performance -->
  <link rel="preload" href="/fonts/YourFont.woff2" as="font" type="font/woff2" crossorigin>
  <!-- Security: Content Security Policy (tighten as needed for new features) -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; font-src 'self'; img-src 'self' data:;">
  <!-- SEO & Social Sharing -->
  <meta name="description" content="Fan Portal: Discover player profiles, AI recaps, and personalize your experience.">
  <meta property="og:title" content="Fan Portal">
  <meta property="og:description" content="Discover player profiles, AI recaps, and personalize your experience.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://yourdomain.com/users/fan/fan.html">
  <meta property="og:image" content="https://yourdomain.com/assets/og-image.png">
  <meta name="twitter:card" content="summary_large_image">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/favicon.ico">
  <style>
    :focus-visible { outline: 2px solid #005fcc; outline-offset: 2px; }
    .visually-hidden { position: absolute !important; width: 1px; height: 1px; margin: -1px; border: 0; padding: 0; overflow: hidden; clip: rect(0 0 0 0); }
    .skip-link { position: absolute; left: -999px; top: auto; width: 1px; height: 1px; overflow: hidden; z-index: 100; }
    .skip-link:focus { left: 1rem; top: 1rem; width: auto; height: auto; background: #fff; color: #005fcc; padding: 0.5em 1em; border-radius: 4px; }
    .noscript-warning { background: #ffeaea; color: #b71c1c; padding: 1em; border-radius: 4px; margin: 1em 0; }
    .theme-controls, .personalization-controls { display: flex; gap: 1em; flex-wrap: wrap; align-items: center; margin: 1em 0; }
    #loading-spinner:not(.visually-hidden) { display: flex; align-items: center; justify-content: center; min-height: 2em; }
    #error-boundary:not(.visually-hidden) { background: #ffeaea; color: #b71c1c; padding: 1em; border-radius: 4px; margin: 1em 0; }
    .skeleton { background: #e0e0e0; border-radius: 4px; min-height: 1.5em; animation: pulse 1.5s infinite; }
    .skeleton.avatar { border-radius: 50%; width: 2em; height: 2em; display: inline-block; margin-right: 0.5em; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    .fab-settings { position: fixed; bottom: 2rem; right: 2rem; z-index: 200; background: #005fcc; color: #fff; border: none; border-radius: 50%; width: 56px; height: 56px; font-size: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .fab-settings:focus { outline: 2px solid #fff; outline-offset: 2px; }
    @media (prefers-reduced-motion: reduce) {
      * { transition: none !important; animation: none !important; }
    }
    .js-enabled .theme-controls { display: flex; }
    .theme-controls { display: none; }
  </style>
</head>
<body>
  <script>
    // Add js-enabled class for progressive enhancement
    document.documentElement.classList.add('js-enabled');
  </script>
  <noscript>
    <div class="noscript-warning" role="alert">
      JavaScript is required for full functionality. Please enable JS.
    </div>
  </noscript>
  <a href="#main-content" class="skip-link" tabindex="0" aria-label="Skip to main content">Skip to main content</a>
  <header role="banner">
    <h1 class="visually-hidden">Fan Portal</h1>
    <nav role="navigation" aria-label="Main navigation">
      <a href="/">Home</a>
      <a href="/users/registration/">Register</a>
      <a href="/users/login.html">Login</a>
    </nav>
  </header>
  <main id="main-content" role="main" tabindex="-1">
    <h2>Welcome to the Fan Portal</h2>
    <div id="fan-content"></div>
    <section id="player-profiles" aria-labelledby="profiles-heading">
      <h2 id="profiles-heading">Player Profiles</h2>
      <ul id="profiles-list">
        <li><span class="skeleton avatar" aria-hidden="true"></span><span class="skeleton" style="width:8em;" aria-hidden="true"></span></li>
        <li><span class="skeleton avatar" aria-hidden="true"></span><span class="skeleton" style="width:8em;" aria-hidden="true"></span></li>
        <li><span class="skeleton avatar" aria-hidden="true"></span><span class="skeleton" style="width:8em;" aria-hidden="true"></span></li>
      </ul>
      <noscript>
        <p>Player profiles require JavaScript. Please enable JS to view this section.</p>
      </noscript>
    </section>
    <section id="ai-recaps" aria-labelledby="recaps-heading">
      <h2 id="recaps-heading">AI Game Recaps</h2>
      <div id="recaps-list">
        <div class="skeleton" aria-hidden="true" style="height:2em;width:100%"></div>
        <div class="skeleton" aria-hidden="true" style="height:2em;width:100%"></div>
      </div>
      <noscript>
        <p>AI recaps require JavaScript. Please enable JS to view this section.</p>
      </noscript>
    </section>
    <aside role="complementary" aria-label="Trending Players" id="trending-players" class="visually-hidden">
      <!-- Example: <h2>Trending Players</h2> -->
    </aside>
    <div id="sr-live-region" aria-live="polite" role="status"></div>
    <div id="error-boundary" role="alert" aria-live="assertive" class="visually-hidden"></div>
    <div id="loading-spinner" class="visually-hidden" aria-live="polite" aria-busy="true">
      <span>Loading...</span>
    </div>
  </main>
  <aside class="theme-controls" aria-label="Theme and personalization controls">
    <label>
      <input type="checkbox" id="contrast-toggle" aria-label="Toggle high contrast mode">
      High Contrast
    </label>
    <label>
      <input type="checkbox" id="dark-mode-toggle" aria-label="Toggle dark mode">
      Dark Mode
    </label>
    <label for="font-size-select">Font Size</label>
    <select id="font-size-select" aria-label="Font size selector">
      <option value="medium">Medium</option>
      <option value="large">Large</option>
      <option value="small">Small</option>
    </select>
    <label>
      <input type="checkbox" id="compact-toggle" aria-label="Toggle compact mode">
      Compact Mode
    </label>
  </aside>
  <button onclick="logout()" id="logout-btn" aria-label="Logout">Logout</button>
  <button id="fab-settings" class="fab-settings" aria-label="Open settings/help" title="Settings/Help" style="display:none;">⚙️</button>
  <footer role="contentinfo">
    <a href="/privacy.html">Privacy Policy</a>
    <button id="feedback-btn" aria-label="Send feedback">Feedback</button>
    <button id="export-data-btn" aria-label="Export my data">Export Data</button>
    <button id="delete-data-btn" aria-label="Delete my data">Delete Data</button>
    <span id="app-version" class="visually-hidden" aria-live="polite"></span>
  </footer>
  <img src="/assets/sample.webp"
       srcset="/assets/sample-480w.avif 480w, /assets/sample-800w.avif 800w, /assets/sample-480w.webp 480w, /assets/sample-800w.webp 800w"
       sizes="(max-width: 600px) 480px, 800px"
       alt="Sample"
       loading="lazy"
       width="400"
       height="200"
       style="display:none;" />
  <!-- Modal Example for Focus Trap and Accessibility -->
  <div id="settings-modal" class="visually-hidden" role="dialog" aria-modal="true" aria-labelledby="settings-modal-title" aria-describedby="settings-modal-desc" tabindex="-1">
    <div>
      <h2 id="settings-modal-title">Settings</h2>
      <p id="settings-modal-desc">Adjust your preferences and accessibility options here.</p>
      <!-- Modal content here -->
      <button id="close-settings-modal" aria-label="Close settings">Close</button>
    </div>
  </div>
  <script type="module" src="fan.js"></script>
  <script type="module" src="/shared/firebase.js"></script>
  <!-- Analytics/Monitoring (respect privacy and consent) -->
  <!-- <script src="/analytics.js" async></script> -->
  <script>
    // Add js-enabled class for progressive enhancement
    document.documentElement.classList.add('js-enabled');

    // Dynamic language switching support
    window.setAppLang = function(lang, localizedLabels = {}) {
      document.documentElement.lang = lang;
      if (localizedLabels['contrast']) document.getElementById('contrast-toggle').setAttribute('aria-label', localizedLabels['contrast']);
      if (localizedLabels['dark']) document.getElementById('dark-mode-toggle').setAttribute('aria-label', localizedLabels['dark']);
      if (localizedLabels['fontSize']) document.getElementById('font-size-select').setAttribute('aria-label', localizedLabels['fontSize']);
      if (localizedLabels['compact']) document.getElementById('compact-toggle').setAttribute('aria-label', localizedLabels['compact']);
      const settingsTitle = document.getElementById('settings-modal-title');
      if (settingsTitle && localizedLabels['settingsTitle']) settingsTitle.textContent = localizedLabels['settingsTitle'];
      const settingsDesc = document.getElementById('settings-modal-desc');
      if (settingsDesc && localizedLabels['settingsDesc']) settingsDesc.textContent = localizedLabels['settingsDesc'];
      const closeBtn = document.getElementById('close-settings-modal');
      if (closeBtn && localizedLabels['close']) closeBtn.setAttribute('aria-label', localizedLabels['close']);
    };

    // Floating Action Button discoverability (show on mobile)
    function showFabIfMobile() {
      const fab = document.getElementById('fab-settings');
      if (window.innerWidth < 700) {
        fab.style.display = 'flex';
        fab.tabIndex = 0;
      } else {
        fab.style.display = 'none';
      }
    }
    window.addEventListener('resize', showFabIfMobile);
    window.addEventListener('DOMContentLoaded', showFabIfMobile);

    // Service Worker registration for PWA/offline support
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js').catch(() => {});
      });
    }

    // Focus trap for modals (to be used by JS-injected modals)
    window.trapFocus = function(modal, trigger) {
      const focusable = modal.querySelectorAll('a, button, input, select, textarea, [tabindex]:not([tabindex="-1"])');
      const first = focusable[0], last = focusable[focusable.length - 1];
      function handleKeydown(e) {
        if (e.key === 'Tab') {
          if (e.shiftKey && document.activeElement === first) {
            last.focus(); e.preventDefault();
          } else if (!e.shiftKey && document.activeElement === last) {
            first.focus(); e.preventDefault();
          }
        }
        if (e.key === 'Escape') {
          modal.dispatchEvent(new CustomEvent('closeModal'));
          if (trigger) trigger.focus();
        }
      }
      modal.addEventListener('keydown', handleKeydown);
      // Remove event listener when modal closes to prevent stacking
      modal.addEventListener('closeModal', function cleanup() {
        modal.removeEventListener('keydown', handleKeydown);
        modal.removeEventListener('closeModal', cleanup);
      });
    };

    // Example: Open/close modal with focus trap and return focus to trigger
    let lastTrigger = null;
    document.getElementById('fab-settings').addEventListener('click', function(e) {
      const modal = document.getElementById('settings-modal');
      lastTrigger = e.currentTarget;
      modal.classList.remove('visually-hidden');
      modal.focus();
      window.trapFocus(modal, lastTrigger);
      // Optionally, set inert on the rest of the page for accessibility
      document.body.querySelectorAll('body > *:not(#settings-modal):not(script)').forEach(el => {
        if (el !== modal) el.inert = true;
      });
    });

    function closeSettingsModal() {
      const modal = document.getElementById('settings-modal');
      modal.classList.add('visually-hidden');
      // Remove inert from the rest of the page
      document.body.querySelectorAll('body > *:not(#settings-modal):not(script)').forEach(el => {
        if (el !== modal) el.inert = false;
      });
      if (lastTrigger) lastTrigger.focus();
    }

    document.getElementById('close-settings-modal').addEventListener('click', closeSettingsModal);
    document.getElementById('settings-modal').addEventListener('closeModal', closeSettingsModal);

    // Example: Cookie consent banner injection (if analytics enabled)
    // window.showCookieConsent = function() { ... }
    // Example: Undo/Redo preview/jump (to be implemented in JS)
    // window.showUndoHistory = function(historyStack) { ... }
  </script>
  <!-- Automated Testing: Integrate axe, Lighthouse, Percy/Chromatic in CI -->
  <!-- Component Documentation: Use Storybook or similar for UI states -->
  <!-- README: Document accessibility, ARIA, and dynamic UI for contributors -->
</body>
</html>